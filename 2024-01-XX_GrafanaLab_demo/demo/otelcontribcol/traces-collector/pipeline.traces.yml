exporters:
  otlphttp/tempo:
    endpoint: http://tempo:4318/

receivers:
  otlp/traces:
    protocols:
      grpc:

processors:
  batch/tempo:
  tail_sampling:
    decision_wait: 10s
    policies:
      [
          # skip traces where latencies are < 1000ms
          {
            name: latency-policy,
            type: latency,
            latency: {threshold_ms: 1000}
          },
          # keep only error traces by skipping 4XX errors
          {
            name: error-policy,
            type: and,
            and:
              {
                and_sub_policy:
                  [
                    {
                      name: status_code-error-policy,
                      type: status_code,
                      status_code: {status_codes: [ERROR]}
                    },
                    # exclude false positive like bad requests or not found
                    {
                      name: http-status-code-error-policy,
                      type: string_attribute,
                      string_attribute:
                        {
                          key: error.type,
                          values: ["[1-4].."],
                          enabled_regex_matching: true,
                          invert_match: true,
                        },
                    },
                    {
                      # apply probabilistic sampling
                      name: probabilistic-policy,
                      type: probabilistic,
                      probabilistic: { sampling_percentage: 1 },
                    },
                  ]
              }
          }
      ]

service:
  pipelines:
    traces/collector:
      receivers: [otlp/traces]
      processors: [tail_sampling, batch/tempo]
      exporters: [otlphttp/tempo]